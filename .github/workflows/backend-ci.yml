name: cardra-server-ci

on:
  push:
    branches: [main]
    paths:
      - 'apps/server/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
    paths:
      - 'apps/server/**'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: cardra
          POSTGRES_USER: cardra_user
          POSTGRES_PASSWORD: cardra_pw
        ports:
          - 5434:5432
        options: >-
          --health-cmd "pg_isready -U cardra_user -d cardra"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: apps/server
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Print Java/Gradle info
        run: |
          java -version
          ./gradlew --version
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('apps/server/**/*.gradle*', 'apps/server/gradlew', 'apps/server/settings.gradle.kts') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Run ktlint + tests + build
        run: |
          chmod +x ./gradlew
          ./gradlew clean test ktlintCheck build
      - name: Smoke test health endpoint
        run: |
          set -euo pipefail
          ./gradlew bootRun --args='--server.port=10099' >/tmp/cardra-smoke.log 2>&1 &
          APP_PID=$!
          cleanup() {
            kill "$APP_PID" >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          for i in {1..60}; do
            if curl -fsS http://localhost:10099/api/v1/health >/dev/null; then
              echo "health check passed"
              exit 0
            fi
            sleep 1
          done

          echo "health check failed"
          tail -n 80 /tmp/cardra-smoke.log
          exit 1
