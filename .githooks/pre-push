#!/usr/bin/env sh
set -eu
set -o pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
SERVER_DIR="$ROOT_DIR/apps/server"
GRADLE_WRAPPER="$SERVER_DIR/gradlew"

if [ ! -x "$GRADLE_WRAPPER" ]; then
  echo "[pre-push] ERROR: gradle wrapper not found or not executable: $GRADLE_WRAPPER"
  exit 1
fi

cd "$SERVER_DIR"

echo "[pre-push] Running ktlintFormat (strict mode) in $SERVER_DIR"
"$GRADLE_WRAPPER" ktlintFormat

echo "[pre-push] Ensure formatter changes are committed"
if ! git diff --exit-code --quiet; then
  echo "[pre-push] ktlintFormat modified files. Please commit formatter results first."
  exit 1
fi

echo "[pre-push] Running ktlintCheck"
"$GRADLE_WRAPPER" ktlintCheck
